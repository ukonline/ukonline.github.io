import{_ as u,o,c as p,x as s,a as e,C as n,z as a,N as t,D as l}from"./chunks/framework.0e180df0.js";const P=JSON.parse(`{"title":"Profil de temps d'exécution","description":"","frontmatter":{},"headers":[],"relativePath":"cours/python/optimisation/audit-de-code/profil-de-temps-d-execution/index.md"}`),y={name:"cours/python/optimisation/audit-de-code/profil-de-temps-d-execution/index.md"},A=t(`<h1 id="profil-de-temps-d-execution" tabindex="-1">Profil de temps d&#39;exécution <a class="header-anchor" href="#profil-de-temps-d-execution" aria-label="Permalink to &quot;Profil de temps d&#39;exécution&quot;">​</a></h1><p>Avec les techniques vues au <a href="./../profilage/">chapitre précédent</a>, tant pour la mesure du temps d&#39;exécution que pour celle de la consommation mémoire, il faut ajouter du code dans le programme à analyser. Lorsque l&#39;on s&#39;intéresse à l&#39;exécution d&#39;un programme et à l&#39;identification des parties les plus consommatrices, il faut procéder à un <em>profilage du code</em>.</p><p>Intéressons-nous d&#39;abord aux différentes principales manières permettant de dresser le profil du temps d&#39;exécution d&#39;un programme afin d&#39;identifier des opportunités ou des nécessités d&#39;optimisation.</p><h2 id="module-line-profiler" tabindex="-1">Module line_profiler <a class="header-anchor" href="#module-line-profiler" aria-label="Permalink to &quot;Module line_profiler&quot;">​</a></h2><p>Le <em>module <code>line_profiler</code></em> permet de réaliser le profilage d&#39;un programme Python en mesurant le temps d&#39;exécution de chacune des lignes de code du programme. Il permet de réaliser un profilage déterministe et est implémenté en C via Cython afin de diminuer au maximum la surcharge inhérente à ce type de profilage.</p><p>Analysons un programme qui permet de calculer le nombre de nombres premiers inférieurs à un nombre <i>n</i> donné. Ce dernier est intégralement repris au listing 4.1 et se compose de deux fonctions. La principale est <code>nb_prime</code> et elle parcourt simplement tous les entiers compris entre 1 et <i>n</i> pour tester s&#39;ils sont premiers, ou non, grâce à la deuxième fonction du programme, à savoir <code>is_prime</code>. Dans le programme, toutes les fonctions qui doivent être profilées sont simplement marquées à l&#39;aide du décorateur <code>@profile</code>. Ce sont les seules qui seront analysées, lorsque l&#39;on utilise le module <code>line_profiler</code> en ligne de commande.</p><figure><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Programme de calcul du nombre de nombres premiers</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Auteur : Sébastien Combéfis</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Version : 6 aout 2021</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Teste si un nombre entier est premier.</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_prime</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">n</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    nb_divisors </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> n</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> n </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            nb_divisors </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> nb_divisors </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Renvoie le nombre de nombres premiers inférieurs à n.</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">profile</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nb_prime</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">n</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    nb </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> n</span><span style="color:#89DDFF;">+</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_prime</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">            nb </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> nb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">nb_prime</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">10000</span><span style="color:#89DDFF;">))</span></span></code></pre></div> <figcaption>Listing 4.1 – Le fichier <code>prime-numbers.py</code> contient un programme de calcul du nombre de nombres premiers.</figcaption></figure><h3 id="en-ligne-de-commande" tabindex="-1">En ligne de commande <a class="header-anchor" href="#en-ligne-de-commande" aria-label="Permalink to &quot;En ligne de commande&quot;">​</a></h3><p>Pour profiler un programme en ligne de commande, il faut passer par deux étapes. La première consiste à réaliser le profilage en tant que tel, grâce à la commande <code>kernprof</code>, qui vient avec le module <code>line_profiler</code> :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&gt; kernprof -l prime-numbers.py</span></span>
<span class="line"><span style="color:#A6ACCD;">1229</span></span>
<span class="line"><span style="color:#A6ACCD;">Wrote profile results to prime-numbers.py.lprof</span></span></code></pre></div><p>L&#39;exécution de cette commande effectue donc le profilage et stocke les résultats de ce dernier dans un fichier binaire portant le même nom que le programme exécuté avec l&#39;extension <code>.lprof</code> en suffixe. Pour visualiser le résultat du profilage, il suffit d&#39;exécuter la commande suivante :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&gt; python3 -m line_profiler prime-numbers.py.lprof</span></span>
<span class="line"><span style="color:#A6ACCD;">Timer unit: 1e-06 s</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Total time: 24.1357 s</span></span>
<span class="line"><span style="color:#A6ACCD;">File: prime-numbers.py</span></span>
<span class="line"><span style="color:#A6ACCD;">Function: nb_prime at line 14</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Line #  Hits       Time PerHit % Time Line Contents</span></span>
<span class="line"><span style="color:#A6ACCD;">===================================================</span></span>
<span class="line"><span style="color:#A6ACCD;">    14                                @profile</span></span>
<span class="line"><span style="color:#A6ACCD;">    15                                def nb_prime(n):</span></span>
<span class="line"><span style="color:#A6ACCD;">    16     1       10.0   10.0    0.0     nb = 0</span></span>
<span class="line"><span style="color:#A6ACCD;">    17 10001     6123.0    0.6    0.0     for i in range(1, n+1):</span></span>
<span class="line"><span style="color:#A6ACCD;">    18 10000 24128646.0 2412.9  100.0         if is_prime(i):</span></span>
<span class="line"><span style="color:#A6ACCD;">    19  1229      897.0    0.7    0.0             nb += 1</span></span>
<span class="line"><span style="color:#A6ACCD;">    20     1        0.0    0.0    0.0     return nb</span></span></code></pre></div><p>On constate que la majorité du temps total d&#39;exécution de la fonction profilée, qui est de 24,1357 s, est consacrée à l&#39;exécution de la 18<sup>e</sup> ligne de code. Elle a été exécutée 10000 fois, tout comme la boucle dans laquelle elle se trouve, exécutée 10001 fois. Une optimisation doit donc s&#39;intéresser à cette ligne de code, et à la 17<sup>e</sup>, le temps passé dans les autres étant comparativement marginal. La conclusion de l&#39;audit est qu&#39;il faut identifier s&#39;il est possible d&#39;avoir une boucle avec moins d&#39;itérations et un meilleur temps d&#39;exécution pour la fonction <code>is_prime</code>.</p><h3 id="en-python" tabindex="-1">En Python <a class="header-anchor" href="#en-python" aria-label="Permalink to &quot;En Python&quot;">​</a></h3><p>Il est également possible d&#39;utiliser le module <code>line_profiler</code> directement en code. Pour cela, il faut d&#39;abord importer le module et ensuite définir le décorateur <code>@profile</code> en créant un objet <code>LineProfiler</code>. On démarre donc le script par les deux instructions suivantes :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">import line_profiler</span></span>
<span class="line"><span style="color:#A6ACCD;">profile = line_profiler.LineProfiler()</span></span></code></pre></div><p>Pour avoir les résultats du profilage de manière visuelle, il faut explicitement demander à ce qu&#39;ils soient affichés en terminant le script avec l&#39;instruction suivante :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">profile.print_stats()</span></span></code></pre></div><p>Le résultat ainsi obtenu est exactement le même que celui obtenu en travaillant directement avec la ligne de commande, si ce n&#39;est pour les numéros de ligne qui ont forcément changé étant donné les nouvelles instructions ajoutées dans le code source du programme.</p><p>L&#39;avantage de travailler directement en Python est qu&#39;il est alors possible de réaliser des analyses plus détaillées des résultats du profilage en utilisant les attributs et méthodes de l&#39;objet de type <code>LineProfiler</code>.</p><h2 id="module-profile" tabindex="-1">Module profile <a class="header-anchor" href="#module-profile" aria-label="Permalink to &quot;Module profile&quot;">​</a></h2><p>Le <em>module <code>profile</code></em> de la librairie standard de Python permet de réaliser le <em>profil de performance</em> d&#39;un programme, en mesurant notamment le temps d&#39;exécution moyen passé dans les différentes fonctions exécutées et le nombre de fois qu&#39;elles ont été appelées, pour une exécution du programme analysé.</p><p>Plus précisément, ce module permet de réaliser un <em>profilage déterministe</em>, c&#39;est-à-dire qu&#39;il monitore précisément tous les appels de fonction, leurs retours et les éventuelles exceptions levées, pour mesurer les temps écoulés entre ces différents évènements.</p><p>Analysons un programme qui permet de trier une liste de nombres à l&#39;aide de l&#39;algorithme de <em>tri à bulles</em> (<i>Bubble sort</i>), pour pouvoir identifier le temps passé dans chacune des fonctions du programme. Ce dernier est intégralement repris au listing 4.2. Le programme se compose de trois fonctions, la principale étant <code>bubble_sort</code> qui réalise le tri à l&#39;aide des deux fonctions auxiliaires <code>is_sorted</code> et <code>swap</code>.</p><figure><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Programme de démonstration du tri à bulles</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Auteur : Sébastien Combéfis</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Version : 26 décembre 2020</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> random</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Teste si une liste est triée de manière croissante.</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_sorted</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">False</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Échange deux valeurs dans une liste.</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">j</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">j</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Trie une liste.</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bubble_sort</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_sorted</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">len</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> i </span><span style="color:#89DDFF;">+</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#A6ACCD;">random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shuffle</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">bubble_sort</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">)</span></span></code></pre></div> <figcaption>Listing 4.2 – Le fichier <code>bubble.py</code> contient un programme de démonstration du tri d&#39;une liste de nombres avec l&#39;algorithm de tri à bulles.</figcaption></figure><h3 id="en-ligne-de-commande-1" tabindex="-1">En ligne de commande <a class="header-anchor" href="#en-ligne-de-commande-1" aria-label="Permalink to &quot;En ligne de commande&quot;">​</a></h3><p>On peut obtenir le profil d&#39;exécution directement en ligne de commande, sans rien devoir modifier au code profilé, comme le montre l&#39;exemple suivant qui réalise le profil de l&#39;exécution du fichier <code>bubble.py</code>, et où seules les lignes correspondant aux trois fonctions qui nous intéressent sont reprises dans le résultat ici affiché :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&gt; python3 -m profile bubble.py</span></span>
<span class="line"><span style="color:#A6ACCD;">      4383 function calls (4356 primitive calls) in 0.031 seconds</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Ordered by: standard name</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ncalls tottime percall cumtime percall filename:lineno(function)</span></span>
<span class="line"><span style="color:#A6ACCD;">[...]</span></span>
<span class="line"><span style="color:#A6ACCD;">   1   0.009   0.009   0.017   0.017 bubble.py:19(bubble_sort)</span></span>
<span class="line"><span style="color:#A6ACCD;">  89   0.001   0.000   0.001   0.000 bubble.py:8(is_sorted)</span></span>
<span class="line"><span style="color:#A6ACCD;">2438   0.007   0.000   0.007   0.000 bubble.py:15(swap)</span></span></code></pre></div><p>Sur cette exécution, on voit ainsi que la fonction <code>bubble_sort</code> a été appelée une seule fois, que la fonction <code>is_sorted</code> a été appelée 89 fois et que 2438 appels à la fonction <code>swap</code> ont été effectués.</p><p>On a également une indication du temps total d&#39;exécution de tout le programme, qui est de 0,031 s, du temps total et cumulé passé dans chaque fonction et des temps moyen par appel de fonction.</p><h3 id="en-python-1" tabindex="-1">En Python <a class="header-anchor" href="#en-python-1" aria-label="Permalink to &quot;En Python&quot;">​</a></h3><p>Il est également possible de directement utiliser le module <code>profile</code> en code. Pour cela, il suffit de l&#39;importer et puis d&#39;appeler la fonction <code>run</code> en lui passant en paramètre le code à exécuter. Par exemple, les trois dernières lignes du programme précédent peuvent être remplacées par :</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#A6ACCD;">random</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">shuffle</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">profile</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">bubble_sort(data)</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>Le résultat de l&#39;exécution, qui est similaire à celui obtenu avec l&#39;utilisation en ligne de commande, est repris ci-dessous :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">2883 function calls in 0.019 seconds</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Ordered by: standard name</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ncalls tottime percall cumtime percall filename:lineno(function)</span></span>
<span class="line"><span style="color:#A6ACCD;">[...]</span></span>
<span class="line"><span style="color:#A6ACCD;">  2594 0.007   0.000   0.007   0.000 bubble.py:15(swap)</span></span>
<span class="line"><span style="color:#A6ACCD;">     1 0.010   0.010   0.018   0.018 bubble.py:19(bubble_sort)</span></span>
<span class="line"><span style="color:#A6ACCD;">    95 0.001   0.000   0.001   0.000 bubble.py:8(is_sorted)</span></span></code></pre></div><p>La première différence est le nombre total d&#39;appels de fonction, simplement due au fait que l&#39;on ne profile plus tout le programme, mais juste l&#39;appel à <code>bubble_sort(data)</code>. La deuxième différence, à savoir les nombres d&#39;appels enregistrés, est simplement due au fait que la liste <code>data</code> à trier est construite aléatoirement.</p><p>Ce type d&#39;analyse permet d&#39;identifier d&#39;éventuels <em>goulots d&#39;étranglement</em> dans l&#39;exécution d&#39;un programme, au niveau de ses fonctions. On peut ainsi identifier celles qui sont très souvent appelées et dont le temps passé à chaque appel est grand. Ce sont celles qu&#39;il faudra investiguer et analyser plus en détail dans le cadre de l&#39;optimisation d&#39;un programme, avec d&#39;autres techniques plus poussées.</p><h3 id="appel-recursif" tabindex="-1">Appel récursif <a class="header-anchor" href="#appel-recursif" aria-label="Permalink to &quot;Appel récursif&quot;">​</a></h3><p>Le module <code>profile</code> peut également être utilisé pour analyser des programmes qui utilisent des <em>fonctions récursives</em>, notamment pour vérifier le nombre d&#39;appels effectués. Reprenons, par exemple, la fonction qui permet de calculer le <i>n</i><sup>e</sup> nombre de Fibonacci :</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">n</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> n </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> n</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">n </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">n </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">profile</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">fib(10)</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>Le résultat de l&#39;analyse de l&#39;appel <code>fib(10)</code> est repris ci-dessous :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">181 function calls (5 primitive calls) in 0.002 seconds</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Ordered by: standard name</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">ncalls tottime percall cumtime percall filename:lineno(function)</span></span>
<span class="line"><span style="color:#A6ACCD;">[...]</span></span>
<span class="line"><span style="color:#A6ACCD;"> 177/1 0.001   0.000   0.001   0.001 prog.py:3(fib)</span></span></code></pre></div>`,42),D={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.05ex"},xmlns:"http://www.w3.org/2000/svg",width:"3.394ex",height:"1.557ex",role:"img",focusable:"false",viewBox:"0 -666 1500 688","aria-hidden":"true"},m=s("g",{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"},[s("g",{"data-mml-node":"math"},[s("g",{"data-mml-node":"mn"},[s("path",{"data-c":"31",d:"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z",style:{"stroke-width":"3"}}),s("path",{"data-c":"38",d:"M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z",transform:"translate(500,0)",style:{"stroke-width":"3"}}),s("path",{"data-c":"31",d:"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z",transform:"translate(1000,0)",style:{"stroke-width":"3"}})])])],-1),C=[m],F=s("code",null,"fib",-1),f=t(`<h3 id="limitation" tabindex="-1">Limitation <a class="header-anchor" href="#limitation" aria-label="Permalink to &quot;Limitation&quot;">​</a></h3><p>Il y a des limitations à l&#39;utilisation du module <code>profile</code>. Comme il ajoute du code pour la mesure du temps d&#39;exécution, lorsqu&#39;il y a plusieurs appels dans une même fonction, celle-ci contiendra beaucoup de code ajouté. La mesure de son temps d&#39;exécution sera dès lors surévaluée, à cause de la surcharge liée à l&#39;exécution du code de monitoring.</p><p>Pour limiter ce défaut, on peut utiliser le <em>module <code>cProfile</code></em>, à la place de <code>profile</code>, un module de plus bas niveau qui rajoute moins de code et qui fonctionne exactement de la même manière que <code>profile</code>.</p><p>Aussi, il faut savoir que le temps mesuré, tant par le module <code>profile</code> que par le module <code>cProfile</code>, est celui passé <em>sur le processeur</em> par le programme. Il n&#39;inclut donc pas les temps d&#39;attente qui peuvent être une cause de lenteur d&#39;un programme. De plus, les mesures réalisées sont souvent faites en développement et ne prennent pas en compte l&#39;environnement réel d&#39;exécution où sera déployé le programme.</p><p>Comme mentionné plus haut, on va pouvoir identifier des possibles goulots d&#39;étranglement à l&#39;aide de ces modules, en identifiant des fonctions dont le temps d&#39;exécution est élevé. Néanmoins, les temps moyens calculés le sont sur des appels précis et ne représentent donc pas du tout le temps moyen d&#39;exécution d&#39;une fonction, peu importe les valeurs de ses paramètres. Il est parfois plus utile de connaitre les appels de fonction lents, avec les valeurs correspondantes des paramètres.</p><p>Enfin, un dernier défaut des modules <code>profile</code> et <code>cProfile</code> est que le résultat qu&#39;ils produisent est très fourni et pas facile à traiter, même avec les possibilités offertes par le module <code>pstats</code>, par exemple.</p><h2 id="module-pyinstrument" tabindex="-1">Module pyinstrument <a class="header-anchor" href="#module-pyinstrument" aria-label="Permalink to &quot;Module pyinstrument&quot;">​</a></h2><p>Une autre possibilité d&#39;analyse consiste à réaliser un <em>profilage statistique</em> d&#39;un programme. Pour rappel, contrairement au profilage déterministe qui compte précisément les appels de fonction et le temps processeur passé dans ces derniers, un profilage statistique fournit une estimation des temps passés dans les différentes fonctions d&#39;un programme.</p><h3 id="en-ligne-de-commande-2" tabindex="-1">En ligne de commande <a class="header-anchor" href="#en-ligne-de-commande-2" aria-label="Permalink to &quot;En ligne de commande&quot;">​</a></h3><p>Le <em>module <code>pyinstrument</code></em> mesure le temps horloge d&#39;exécution, contrairement aux modules <code>profile</code> et <code>cProfile</code> qui mesurent le temps processeur, pour prendre en compte les ralentissements causés par les opérations disque, requêtes réseau, etc. Voici le résultat d&#39;exécution, simplifié pour la présentation dans ce livre, sur le programme <code>bubble.py</code> :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&gt; python3 -m pyinstrument bubble.py</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  _     ._   __/__   _ _  _  _ _/_ Recorded: 21:16 Samples:  254</span></span>
<span class="line"><span style="color:#A6ACCD;"> /_//_/// /_\\ / //_// / //_&#39;/ //   Duration: 0.258 CPU time: 0.25</span></span>
<span class="line"><span style="color:#A6ACCD;">/   _/                      v3.3.0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Program: bubble.py</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">0.257 &lt;module&gt;  bubble.py:1</span></span>
<span class="line"><span style="color:#A6ACCD;">└─ 0.256 bubble_sort  bubble.py:19</span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ 0.191 [self]  </span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ 0.060 swap  bubble.py:15</span></span>
<span class="line"><span style="color:#A6ACCD;">   └─ 0.005 is_sorted  bubble.py:8</span></span></code></pre></div><p>Comme on peut le voir, le résultat représente l&#39;arbre d&#39;exécution avec l&#39;enchainement des fonctions appelées. Pour chacune d&#39;entre elles, on voit qui l&#39;a appelée, qui elle appelle et une estimation de son temps d&#39;exécution. On voit, par exemple, que sur les 0,256 s passée dans la fonction <code>bubble_sort</code>, 0,191 s l&#39;est dans la fonction elle-même, 0,060 s l&#39;est dans la fonction <code>swap</code> et, enfin, 0,005 s l&#39;est dans <code>is_sorted</code>.</p><p>Le fonctionnement du module est assez simple et ne nécessite pas beaucoup d&#39;ajout de code. Toutes les millisecondes durant l&#39;exécution, le module examine dans quelle fonction se trouve le programme et le mémorise. Finalement, il pourrait ainsi avoir une estimation du pourcentage de temps passé dans chaque fonction. Dans le résultat présenté plus haut, on voit d&#39;ailleurs qu&#39;il y a eu 254 échantillons faits.</p><p>Les avantages de cette méthode de profilage statistique sont donc une mesure équitable du temps d&#39;exécution de chaque fonction, sans distorsion des résultats et un résultat qui n&#39;affiche que les fonctions pertinentes, avec une présentation beaucoup plus claire à lire. Enfin, le fait de voir l&#39;arbre d&#39;exécution permet également de retrouver plus facilement le contexte dans lequel les lenteurs relevées ont été mesurées, la même fonction pouvant apparaitre plusieurs fois dans l&#39;arbre, avec des vitesses moyennes d&#39;exécution différentes.</p><h3 id="en-python-2" tabindex="-1">En Python <a class="header-anchor" href="#en-python-2" aria-label="Permalink to &quot;En Python&quot;">​</a></h3><p>Outre l&#39;utilisation en ligne de commande, le module <code>pyinstrument</code> peut également être directement utilisé depuis un programme Python, comme le montre l&#39;exemple suivant, où un <code>sleep</code> a été ajouté pour artificiellement ralentir l&#39;exécution, sans quoi aucune information n&#39;aurait été capturée :</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> time</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> pyinstrument </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Profiler</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">n</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    time</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sleep</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0.01</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> n </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> n</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">n </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">n </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">profiler </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Profiler</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">profiler</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">start</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">fib</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">profiler</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stop</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">profiler</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">output_text</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">unicode</span><span style="color:#89DDFF;">=True,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">color</span><span style="color:#89DDFF;">=True))</span></span></code></pre></div><p>Comme on peut le voir sur le résultat de l&#39;exécution, on a clairement une fonction récursive. Contrairement aux modules <code>profile</code> et <code>cProfile</code>, on peut voir une estimation des temps d&#39;exécution des appels individuels, qui sont ici quasi les mêmes à chaque fois, à savoir environ 0,1 s :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">_     ._   __/__   _ _  _  _ _/_ Recorded: 11:56 Samples:  9</span></span>
<span class="line"><span style="color:#A6ACCD;"> /_//_/// /_\\ / //_// / //_&#39;/ //   Duration: 0.104 CPU time: 0.01</span></span>
<span class="line"><span style="color:#A6ACCD;">/   _/                      v3.3.0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Program: prog.py</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">0.104 &lt;module&gt;  prog.py:1</span></span>
<span class="line"><span style="color:#A6ACCD;">└─ 0.104 fib  prog.py:4</span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ 0.091 fib  prog.py:4</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ 0.066 fib  prog.py:4</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  ├─ 0.043 sleep  &lt;built-in&gt;:0</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  │     [2 frames hidden]  &lt;built-in&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  └─ 0.023 fib  prog.py:4</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │     └─ 0.023 sleep  &lt;built-in&gt;:0</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │           [2 frames hidden]  &lt;built-in&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  └─ 0.025 sleep  &lt;built-in&gt;:0</span></span>
<span class="line"><span style="color:#A6ACCD;">   │        [2 frames hidden]  &lt;built-in&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">   └─ 0.013 sleep  &lt;built-in&gt;:0</span></span>
<span class="line"><span style="color:#A6ACCD;">         [2 frames hidden]  &lt;built-in&gt;</span></span></code></pre></div><h2 id="module-eliot" tabindex="-1">Module eliot <a class="header-anchor" href="#module-eliot" aria-label="Permalink to &quot;Module eliot&quot;">​</a></h2><p>Dans le même esprit qu&#39;avec <code>pyinstrument</code>, il est intéressant de pouvoir visualiser l&#39;arbre d&#39;exécution d&#39;un programme afin de savoir ce qui a conduit à une fonction lente à s&#39;exécuter. Aussi, comme expliqué dans les limitations des modules <code>profile</code> et <code>cProfile</code>, avoir un seul temps moyen d&#39;exécution pour une même fonction est réducteur. Le module <code>pyinstrument</code> que l&#39;on vient de voir permet de prendre en compte le contexte d&#39;appel des fonctions, qui peut influencer le temps d&#39;exécution d&#39;une même fonction. Un autre élément d&#39;influence des temps d&#39;exécution est la valeur des paramètres d&#39;appel.</p><p>Le <em>module <code>eliot</code></em> va plus loin en permettant de constituer un log qui reprend à la fois l&#39;arbre d&#39;exécution et les valeurs des paramètres utilisées pour les appels de fonction. Il combine les avantages d&#39;un log, qui permet de retracer les appels qui ont été exécutés, avec ceux d&#39;un monitoring du temps d&#39;exécution, qui permet d&#39;identifier des éventuels goulots d&#39;étranglement dans un programme.</p><p>Une utilisation simple du module <code>eliot</code> consiste à ajouter le décorateur <code>@log_call</code> aux fonctions à monitorer, d&#39;indiquer où le fichier de logs doit être sauvegardé et enfin d&#39;exécuter le programme. Reprenons notre exemple de tri à bulles, mais sur une petite liste de deux éléments :</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> eliot </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> log_call</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> to_file</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">log_call</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">is_sorted</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># [...]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">log_call</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">swap</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">j</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># [...]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">log_call</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bubble_sort</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">data</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># [...]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">to_file</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">open</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">bubble.log</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">w</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">data </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#82AAFF;">bubble_sort</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>Après exécution du programme, un fichier <code>bubble.log</code> contenant les logs a été créé. Il peut être visualisé avec l&#39;outil <code>eliot-tree</code> pour obtenir le résultat suivant, simplifié pour la présentation dans ce livre :</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&gt; eliot-tree bubble.log</span></span>
<span class="line"><span style="color:#A6ACCD;">57369673-eb62-4312-a646-c8adfd35e406</span></span>
<span class="line"><span style="color:#A6ACCD;">└─ bubble_sort/1 ⇒ started 2020-12-27 10:27:37Z ⧖ 0.001s</span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ data: </span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ 0: 3</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  └─ 1: 1</span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ is_sorted/2/1 ⇒ started 2020-12-27 10:27:37Z ⧖ 0.000s</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ data: </span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  ├─ 0: 3</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  └─ 1: 1</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  └─ is_sorted/2/2 ⇒ succeeded 2020-12-27 10:27:37Z</span></span>
<span class="line"><span style="color:#A6ACCD;">   │     └─ result: False</span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ swap/3/1 ⇒ started 2020-12-27 10:27:37Z ⧖ 0.000s</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ data: </span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  ├─ 0: 3</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  └─ 1: 1</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ i: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ j: 1</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  └─ swap/3/2 ⇒ succeeded 2020-12-27 10:27:37Z</span></span>
<span class="line"><span style="color:#A6ACCD;">   │     └─ result: None</span></span>
<span class="line"><span style="color:#A6ACCD;">   ├─ is_sorted/4/1 ⇒ started 2020-12-27 10:27:37Z ⧖ 0.000s</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  ├─ data: </span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  ├─ 0: 1</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  │  └─ 1: 3</span></span>
<span class="line"><span style="color:#A6ACCD;">   │  └─ is_sorted/4/2 ⇒ succeeded 2020-12-27 10:27:37Z</span></span>
<span class="line"><span style="color:#A6ACCD;">   │     └─ result: True</span></span>
<span class="line"><span style="color:#A6ACCD;">   └─ bubble_sort/5 ⇒ succeeded 2020-12-27 10:27:37Z</span></span>
<span class="line"><span style="color:#A6ACCD;">      └─ result: None</span></span></code></pre></div><p>La principale limitation des outils basés sur des logs est que ces derniers peuvent très vite occuper beaucoup de place en mémoire, sur le disque, et également devenir complexes à lire et analyser. Aussi, la surcharge causée par l&#39;exécution du code ajouté pour l&#39;écriture des logs ralentit l&#39;exécution du programme.</p>`,27);function b(g,h,v,_,x,q){const r=l("mn"),c=l("math"),i=l("mjx-assistive-mml"),d=l("mjx-container");return o(),p("div",null,[A,s("p",null,[e("Sur ce résultat, on voit tout d'abord qu'il y a eu un total de "),n(d,{class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},{default:a(()=>[(o(),p("svg",D,C)),n(i,{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},{default:a(()=>[n(c,{xmlns:"http://www.w3.org/1998/Math/MathML"},{default:a(()=>[n(r,null,{default:a(()=>[e("181")]),_:1})]),_:1})]),_:1})]),_:1}),e(" appels de fonction. Concernant la fonction récursive "),F,e(", on voit qu'elle a été appelée 171/1 fois. S'il y a deux nombres, c'est précisément parce qu'il s'agit d'un appel récursif, le premier indiquant le nombre total d'appels et le second indiquant le nombre d'appels primitifs.")]),f])}const E=u(y,[["render",b]]);export{P as __pageData,E as default};
